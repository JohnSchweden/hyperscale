---
phase: 01-layout-foundation
plan: 10
type: execute
wave: 1
depends_on: []
files_modified: [App.tsx, components/LayoutShell.tsx]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Answer overlay window centered on mobile screen"
    - "Game screen HUD fully visible at top, not cut off"
  artifacts:
    - path: "components/LayoutShell.tsx"
      provides: "Positioning context for absolutely positioned children"
      changes: "Add relative positioning to root container div (line 25)"
    - path: "App.tsx"
      provides: "HUD with proper top positioning"
      changes: "Wrap HUD in positioned container or adjust top offset (line 534)"
    - path: "App.tsx"
      provides: "Feedback overlay outside transform context"
      changes: "Move feedback overlay to root level (after LayoutShell) or use React Portal approach"
  key_links:
    - from: "App.tsx HUD"
      to: "LayoutShell.tsx container"
      pattern: "relative container establishes positioning context for absolute children"
    - from: "App.tsx feedback overlay"
      to: "Viewport (not transformed ancestor)"
      pattern: "Overlay renders outside stage-transition transformed container"
---

<objective>
Fix answer overlay centering on mobile and HUD cutoff at top by establishing proper CSS positioning contexts.

Purpose: 
1. Answer overlay uses `position: fixed` but appears inside a container with `stage-transition` animation that applies `transform`, breaking the viewport-relative positioning
2. HUD uses `position: absolute` but has no positioned ancestor, causing it to position relative to viewport and ignore LayoutShell's padding

Output: Answer overlay properly centered on mobile viewport; HUD fully visible below safe area insets and LayoutShell padding.
</objective>

<execution_context>
@/Users/yevgenschweden/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/yevgenschweden/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-layout-foundation/01-UAT.md
@/Users/yevgenschweden/hyperscale/App.tsx
@/Users/yevgenschweden/hyperscale/components/LayoutShell.tsx

## Gap Details (from UAT)

**Gap 2: Overlay Centering (Major)**
- Truth: "Answer overlay window centered on mobile screen"
- Status: Failed
- Root cause: stage-transition CSS animation applies `transform` to root container, creating a containing block that breaks `position: fixed` on the overlay (fixed positioning becomes relative to transformed ancestor instead of viewport)
- Artifacts:
  - `App.tsx` line 963: Root container has `stage-transition` class with transform animation
  - `index.html` lines 115-117: stage-transition animation uses transform with forwards fill mode, persisting after animation
  - `LayoutShell.tsx` line 26: overflow-hidden creates additional containing block complications
- Missing:
  - Move feedback overlay outside transformed container using React Portal
  - Or remove/restructure stage-transition animation so it doesn't apply transform to overlay ancestor
  - Or apply animation to inner wrapper instead of root container

**Gap 5: HUD Cutoff (Major)**
- Truth: "Game screen HUD fully visible at top, not cut off"
- Status: Failed
- Root cause: HUD uses absolute positioning with `top-2` but has no positioned ancestor container, causing it to position relative to viewport and ignore LayoutShell's `pt-16` padding and safe area insets
- Artifacts:
  - `App.tsx` line 534: HUD uses `absolute top-2` without positioned parent
  - `LayoutShell.tsx` line 26: Container lacks `relative` positioning to establish positioning context
  - `LayoutShell.tsx` line 28: `pt-16` padding on mobile is ignored by absolutely positioned HUD

## Positioning Context Issues

**CSS Containing Block Rules:**
1. `position: fixed` positions relative to viewport UNLESS ancestor has `transform`, `perspective`, or `filter`
2. `position: absolute` positions relative to nearest positioned ancestor (has `position: relative/absolute/fixed/sticky`)
3. `overflow: hidden` can also create containing blocks in some browsers

**Current Issues:**
1. App.tsx root div has `stage-transition` → applies `transform: translateY()` during animation → creates containing block → breaks `fixed` overlay positioning
2. LayoutShell container lacks `relative` → HUD's `absolute` positions to viewport → ignores `pt-16` padding → gets cut off
</context>

<tasks>

<task type="auto">
  <name>Add relative positioning to LayoutShell for HUD positioning context</name>
  <files>components/LayoutShell.tsx (line 24-33)</files>
  <action>
    Add `relative` class to the root container div to establish a positioning context for absolutely positioned children like the HUD.
    
    Current code (lines 24-33):
    ```tsx
    return (
      <div
        className={`
          flex flex-col w-full
          lg:items-center lg:justify-center items-start pt-16 lg:pt-0
          min-h-[100dvh]
          bg-black
          safe-area-top safe-area-bottom
          ${className}
        `.trim()}
      >
    ```
    
    Change to (add `relative` class):
    ```tsx
    return (
      <div
        className={`
          relative flex flex-col w-full
          lg:items-center lg:justify-center items-start pt-16 lg:pt-0
          min-h-[100dvh]
          bg-black
          safe-area-top safe-area-bottom
          ${className}
        `.trim()}
      >
    ```
    
    Rationale:
    - `relative` establishes a positioning context without affecting layout
    - HUD's `absolute top-2` will now position relative to this container, not viewport
    - Container's `pt-16` (64px top padding on mobile) will push HUD down properly
    - Safe area insets (safe-area-top) will also be respected
    - Desktop (`lg:`) behavior unchanged since `lg:pt-0` removes padding
  </action>
  <verify>Check LayoutShell.tsx - the className should start with "relative flex flex-col w-full"</verify>
  <done>LayoutShell root container has `relative` class establishing positioning context</done>
</task>

<task type="auto">
  <name>Adjust HUD positioning to work within new context</name>
  <files>App.tsx (lines 533-534)</files>
  <action>
    Adjust the HUD's positioning to ensure it renders properly within the LayoutShell's positioning context.
    
    Current HUD (lines 533-534):
    ```tsx
    {/* Top HUD - Budget Focused - Mobile Optimized */}
    <div className="absolute top-2 md:top-4 left-1/2 -translate-x-1/2 w-full max-w-4xl px-3 md:px-4 flex flex-col md:flex-row gap-2 md:gap-6 items-stretch md:items-center z-10">
    ```
    
    After adding `relative` to LayoutShell, the HUD will position relative to the container. The current `top-2` might be too close to the edge considering:
    - LayoutShell has `pt-16` (64px) on mobile
    - Safe area insets may add more top padding
    
    Keep the HUD code as-is for now. The `relative` container should fix the main issue. The `top-2` will position 8px from the LayoutShell container's content edge (after the pt-16 padding is applied).
    
    However, if testing shows the HUD is still too close to the top, we can adjust to `top-4` (16px) for more breathing room.
    
    For now: No change to HUD className, but verify positioning works correctly with the new relative container.
  </action>
  <verify>Check that HUD className still has `absolute top-2 md:top-4`</verify>
  <done>HUD positioning preserved; will now position relative to LayoutShell container instead of viewport</done>
</task>

<task type="auto">
  <name>Move feedback overlay outside transformed container</name>
  <files>App.tsx (lines 716-751, 960-966)</files>
  <action>
    Move the feedback overlay from inside renderGame() to render at the App root level, outside the stage-transition container.
    
    Current structure:
    1. App root div has `stage-transition` class (line 963)
    2. renderGame() is called inside this div
    3. Feedback overlay is rendered inside renderGame() (lines 717-751)
    4. This puts the overlay inside a transformed container, breaking fixed positioning
    
    Solution: Move feedback overlay to render alongside renderStage() at the App root level.
    
    Step 1: Remove feedback overlay from renderGame()
    
    In renderGame(), find and remove lines 716-751 (the feedbackOverlay conditional render):
    ```tsx
    {/* Answer Window - Overlay with fine display */}
    {feedbackOverlay &&
      (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 md:p-6 bg-black/70 backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="feedback-overlay-title" aria-describedby="feedback-overlay-desc">
          <div className="w-full max-w-lg bg-slate-900 border border-slate-700 p-6 md:p-10 rounded-2xl text-center shadow-2xl max-h-[90vh] overflow-y-auto">
            ...
          </div>
        </div>
      )
    }
    ```
    
    Step 2: Add feedback overlay to main App return
    
    Current return (lines 962-966):
    ```tsx
    return (
      <div className="min-h-[100dvh] stage-transition" key={state.stage}>
        {renderStage()}
      </div>
    );
    ```
    
    Change to (add overlay after renderStage, outside stage-transition div):
    ```tsx
    return (
      <>
        <div className="min-h-[100dvh] stage-transition" key={state.stage}>
          {renderStage()}
        </div>
        {state.stage === GameStage.PLAYING && feedbackOverlay && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 md:p-6 bg-black/70 backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="feedback-overlay-title" aria-describedby="feedback-overlay-desc">
            <div className="w-full max-w-lg bg-slate-900 border border-slate-700 p-6 md:p-10 rounded-2xl text-center shadow-2xl max-h-[90vh] overflow-y-auto">
              <h2 id="feedback-overlay-title" className="sr-only">Governance feedback</h2>
              <div className={`text-4xl md:text-6xl mb-4 md:mb-6 ${feedbackOverlay.fine > 0 ? 'text-red-500' : 'text-green-500'}`}>
                <i className={`fa-solid ${feedbackOverlay.fine > 0 ? 'fa-triangle-exclamation' : 'fa-circle-check'}`} aria-hidden></i>
              </div>
              
              {feedbackOverlay.fine > 0 && (
                <div className="mb-4 md:mb-6 p-3 md:p-4 bg-red-900/20 border border-red-500/30 rounded-lg">
                  <div className="text-red-400 text-xs font-bold tracking-wide mb-1">Violation fine</div>
                  <div className="text-2xl md:text-3xl font-black text-red-500">-{formatBudget(feedbackOverlay.fine)}</div>
                  <div className="text-red-400/70 text-xs mt-1">{feedbackOverlay.violation}</div>
                </div>
              )}
              
              <div className="text-cyan-400 mono text-[10px] mb-3 md:mb-4 font-bold tracking-wide">{PERSONALITIES[state.personality!].name}'s review</div>
              <p className="text-lg md:text-2xl mb-4 md:mb-8 italic text-slate-100 font-light leading-relaxed">"{feedbackOverlay.text}"</p>
              
              <div id="feedback-overlay-desc" className="bg-black/50 border border-white/5 p-4 md:p-6 rounded-xl text-left mb-4 md:mb-8 min-h-[4.5rem]">
                <div className="text-[10px] font-bold text-slate-400 tracking-wide mb-3 border-b border-white/5 pb-2">Governance alert</div>
                <p className="text-xs md:text-sm text-slate-400 leading-relaxed font-light">{feedbackOverlay.lesson}</p>
              </div>

              <button 
                onClick={nextIncident}
                className="w-auto px-8 py-2.5 text-sm md:text-base bg-white text-black font-black tracking-wide hover:bg-cyan-500 transition-all shadow-xl transform active:scale-95"
              >
                Next ticket
              </button>
            </div>
          </div>
        )}
      </>
    );
    ```
    
    Step 3: Import GameStage enum if not already imported
    Check that `GameStage` is imported at the top of the file. It should already be imported from './types' (line 2).
    
    Rationale:
    - By rendering the overlay as a sibling to the stage-transition div (not a child), it escapes the transformed containing block
    - `position: fixed` will now properly position relative to the viewport
    - The overlay will be centered correctly on mobile regardless of any transform animations on the main content
    - Using React Fragment (`<>...</>`) keeps the return structure clean
    - Conditional check `state.stage === GameStage.PLAYING` ensures overlay only shows during Game screen (where it's used)
  </action>
  <verify>
    1. Search App.tsx for feedback overlay in renderGame - should NOT find the overlay JSX there anymore
    2. Check main return statement - should show overlay as sibling to stage-transition div
    3. Verify GameStage is in scope (imported from types)
  </verify>
  <done>Feedback overlay moved outside stage-transition container; now renders at viewport level with proper fixed positioning</done>
</task>

<task type="auto">
  <name>Import React Fragment wrapper</name>
  <files>App.tsx (line 962-967)</files>
  <action>
    Ensure the return statement properly wraps content in a React Fragment since we're now returning multiple elements.
    
    The code in task 3 already shows the fragment wrapper:
    ```tsx
    return (
      <>
        <div className="min-h-[100dvh] stage-transition" key={state.stage}>
          {renderStage()}
        </div>
        {state.stage === GameStage.PLAYING && feedbackOverlay && (
          ...overlay JSX...
        )}
      </>
    );
    ```
    
    This is valid React - fragments allow returning multiple elements without adding DOM nodes.
    
    No additional imports needed - React.Fragment is built-in.
  </action>
  <verify>Verify the return statement starts with `<>` and ends with `</>`</verify>
  <done>App return uses React Fragment to wrap stage container and overlay</done>
</task>

</tasks>

<verification>

### Automated Verification
1. **Code review**: 
   - LayoutShell has `relative` class
   - Feedback overlay removed from renderGame
   - Feedback overlay added to main App return
   - App return uses fragment wrapper
2. **Build check**: `bun run build` should complete without errors
3. **Type check**: TypeScript should not report errors about missing GameStage

### Manual Verification Steps

**HUD Verification:**
1. Open the app on mobile (or mobile emulator)
2. Navigate to Game screen
3. **Check HUD position**: Budget/Risk/Hype bars should be:
   - Fully visible (not cut off at top)
   - Positioned below the status bar/safe area
   - Have proper spacing from top edge
4. Compare with before: HUD should now be lower (respecting pt-16 padding)

**Answer Overlay Verification:**
1. On Game screen, make a choice (swipe or click button)
2. **Check overlay positioning**: Feedback window should be:
   - Centered horizontally on mobile screen
   - Centered vertically (or properly positioned)
   - Not offset or misaligned
   - Fully visible on screen
3. Test on different mobile sizes: iPhone SE, iPhone 14, Android
4. Verify overlay still works on desktop (should be unchanged or improved)

### Success Criteria
- [ ] HUD is fully visible at top of Game screen, not cut off
- [ ] Answer overlay is centered on mobile viewport
- [ ] Overlay positioning is consistent across different screen sizes
- [ ] Desktop layout remains functional
- [ ] All 8 stages still navigate correctly
- [ ] No console errors or TypeScript errors

</verification>

<success_criteria>
- **Observable truth**: "Answer overlay window centered on mobile screen" - Overlay appears centered when user makes a choice on mobile
- **Observable truth**: "Game screen HUD fully visible at top, not cut off" - HUD displays completely with proper top spacing
- **Code changes**:
  - LayoutShell.tsx: Added `relative` class
  - App.tsx: Removed overlay from renderGame; added to root return with fragment wrapper
- **Build**: Passes without errors
- **Positioning**: 
  - HUD positions relative to LayoutShell (not viewport)
  - Overlay positions relative to viewport (not affected by transforms)
</success_criteria>

<output>
After completion, create `.planning/phases/01-layout-foundation/01-10-SUMMARY.md`

Include:
- Changes made to LayoutShell.tsx and App.tsx
- Explanation of CSS containing block fix
- Verification results
- Any additional notes
</output>
